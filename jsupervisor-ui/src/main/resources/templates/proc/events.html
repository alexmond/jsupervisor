<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4" th:text="${pageModel.title}">Process Events</h1>

            <!-- Filter and Controls Row -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label class="me-2 text-nowrap" for="processFilter">Filter by Process:</label>
                        <select class="form-select" id="processFilter" onchange="filterByProcess(this.value)">
                            <option th:selected="${pageModel.filterProcessName == null}" value="all">All Processes
                            </option>
                            <option th:each="processName : ${pageModel.availableProcessNames}"
                                    th:selected="${processName == pageModel.filterProcessName}"
                                    th:text="${processName}"
                                    th:value="${processName}">
                                Process Name
                            </option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fa-solid fa-arrows-rotate"></i> Refresh
                    </button>

                    <!-- Page Size Selector -->
                    <div aria-label="Page size" class="btn-group" role="group">
                        <span class="btn btn-outline-secondary disabled">Items per page:</span>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageModel.pageSize == 10 ? 'active' : ''}"
                           th:href="@{/events(page=0, size=10, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">10</a>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageModel.pageSize == 20 ? 'active' : ''}"
                           th:href="@{/events(page=0, size=20, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">20</a>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageModel.pageSize == 50 ? 'active' : ''}"
                           th:href="@{/events(page=0, size=50, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">50</a>
                        <a class="btn btn-outline-secondary"
                           th:classappend="${pageModel.pageSize == 100 ? 'active' : ''}"
                           th:href="@{/events(page=0, size=100, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">100</a>
                    </div>
                </div>
                <div class="col-md-2 text-end text-muted">
                    Showing <span th:text="${pageModel.eventsPage.numberOfElements}">0</span> of
                    <span th:text="${pageModel.totalElements}">0</span> events
                </div>
            </div>

            <!-- Events Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>
                            <a th:href="@{/events(page=${pageModel.currentPage}, size=${pageModel.pageSize}, sortBy='processName', sortDirection=${pageModel.sortBy == 'processName' and pageModel.sortDirection == 'asc' ? 'desc' : 'asc'}, filterProcessName=${pageModel.filterProcessName})}">
                                Process Name
                                <i class="fa-solid"
                                   th:classappend="${pageModel.sortBy == 'processName' ? (pageModel.sortDirection == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></i>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/events(page=${pageModel.currentPage}, size=${pageModel.pageSize}, sortBy='newStatus', sortDirection=${pageModel.sortBy == 'newStatus' and pageModel.sortDirection == 'asc' ? 'desc' : 'asc'}, filterProcessName=${pageModel.filterProcessName})}">
                                New Status
                                <i class="fa-solid"
                                   th:classappend="${pageModel.sortBy == 'newStatus' ? (pageModel.sortDirection == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></i>
                            </a>
                        </th>
                        <th>Old Status</th>
                        <th>PID</th>
                        <th>
                            <a th:href="@{/events(page=${pageModel.currentPage}, size=${pageModel.pageSize}, sortBy='eventTime', sortDirection=${pageModel.sortBy == 'eventTime' and pageModel.sortDirection == 'asc' ? 'desc' : 'asc'}, filterProcessName=${pageModel.filterProcessName})}">
                                Event Time
                                <i class="fa-solid"
                                   th:classappend="${pageModel.sortBy == 'eventTime' ? (pageModel.sortDirection == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></i>
                            </a>
                        </th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Exit Code</th>
                        <th>Uptime</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="event : ${pageModel.eventsPage.content}">
                        <td th:text="${event.processName}">Process Name</td>
                        <td>
                            <span class="badge"
                                  th:classappend="${@uiconfig.uiStatusClass.get(event.newStatus)}"
                                  th:text="${event.newStatus}">Status</span>
                        </td>
                        <td>
                            <span class="badge"
                                  th:classappend="${@uiconfig.uiStatusClass.get(event.oldStatus)}"
                                  th:text="${event.oldStatus}">Status</span>
                        </td>
                        <td th:text="${event.pid != null ? event.pid : '-'}">PID</td>
                        <td th:text="${event.eventTime != null ? #temporals.format(event.eventTime, 'yyyy-MM-dd HH:mm:ss') : '-'}">
                            Event Time
                        </td>
                        <td th:text="${event.startTime != null ? #temporals.format(event.startTime, 'yyyy-MM-dd HH:mm:ss') : '-'}">
                            Start Time
                        </td>
                        <td th:text="${event.endTime != null ? #temporals.format(event.endTime, 'yyyy-MM-dd HH:mm:ss') : '-'}">
                            End Time
                        </td>
                        <td th:text="${event.exitCode != null ? event.exitCode : '-'}">Exit Code</td>
                        <td th:text="${event.processUptime != null ? event.processUptime.toString().substring(2).replaceAll('(\\d[HMS])(?!$)', '$1 ').toLowerCase() : '-'}">
                            Uptime
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(pageModel.eventsPage.content)}">
                        <td class="text-center text-muted" colspan="9">No events found</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <nav aria-label="Event pagination" th:if="${pageModel.totalPages > 1}">
                <ul class="pagination justify-content-center">
                    <!-- First Page -->
                    <li class="page-item" th:classappend="${pageModel.currentPage == 0 ? 'disabled' : ''}">
                        <a class="page-link"
                           th:href="@{/events(page=0, size=${pageModel.pageSize}, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">
                            <i class="fa-solid fa-angles-left"></i> First
                        </a>
                    </li>

                    <!-- Previous Page -->
                    <li class="page-item" th:classappend="${pageModel.currentPage == 0 ? 'disabled' : ''}">
                        <a class="page-link"
                           th:href="@{/events(page=${pageModel.currentPage - 1}, size=${pageModel.pageSize}, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">
                            <i class="fa-solid fa-angle-left"></i> Previous
                        </a>
                    </li>

                    <!-- Page Numbers (using pre-calculated list from controller) -->
                    <li class="page-item"
                        th:classappend="${i == pageModel.currentPage ? 'active' : ''}"
                        th:each="i : ${pageModel.pageNumbers}">
                        <a class="page-link"
                           th:href="@{/events(page=${i}, size=${pageModel.pageSize}, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}"
                           th:text="${i + 1}">1</a>
                    </li>

                    <!-- Next Page -->
                    <li class="page-item"
                        th:classappend="${pageModel.currentPage >= pageModel.totalPages - 1 ? 'disabled' : ''}">
                        <a class="page-link"
                           th:href="@{/events(page=${pageModel.currentPage + 1}, size=${pageModel.pageSize}, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">
                            Next <i class="fa-solid fa-angle-right"></i>
                        </a>
                    </li>

                    <!-- Last Page -->
                    <li class="page-item"
                        th:classappend="${pageModel.currentPage >= pageModel.totalPages - 1 ? 'disabled' : ''}">
                        <a class="page-link"
                           th:href="@{/events(page=${pageModel.totalPages - 1}, size=${pageModel.pageSize}, sortBy=${pageModel.sortBy}, sortDirection=${pageModel.sortDirection}, filterProcessName=${pageModel.filterProcessName})}">
                            Last <i class="fa-solid fa-angles-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script th:inline="javascript">
    function filterByProcess(processName) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentSize = urlParams.get('size') || '20';
        const currentSortBy = urlParams.get('sortBy') || 'eventTime';
        const currentSortDirection = urlParams.get('sortDirection') || 'desc';

        let url = `/events?page=0&size=${currentSize}&sortBy=${currentSortBy}&sortDirection=${currentSortDirection}`;

        if (processName && processName !== 'all') {
            url += `&filterProcessName=${encodeURIComponent(processName)}`;
        }

        window.location.href = url;
    }
</script>
</body>
</html>